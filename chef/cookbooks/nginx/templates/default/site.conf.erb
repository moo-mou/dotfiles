<% @upstreams.each do |upstream| %>
upstream <%= upstream[:name] %> {
    server <%= upstream[:address] %>;
}
<% end %>

<% @servers.each do |server| %>
# <%= server[:name] %>
server {
    listen 80;
    listen [::]:80;
    server_name <%= "#{server[:name]}.#{@root_url}" %>;
    return 301 https://$server_name$request_uri;
}
# <%= server[:name] %>
server {
    # SSL configuration
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    include snippets/ssl-<%= @root_url %>.conf;
    include snippets/ssl-params.conf;

    server_name <%= "#{server[:name]}.#{@root_url}" %>;
    add_header Strict-Transport-Security "max-age=15768000; includeSubDomains: always;";

    access_log /var/log/nginx/<%= @root_url %>/<%= server[:name]%>/access.log;
    error_log /var/log/nginx/<%= @root_url %>/<%= server[:name]%>/error.log;

    <% if server[:root] %>
    root <%= server[:root] %>;
    <% end %>

    location / {
        <% if server[:upstream] %>
        proxy_pass http://<%= server[:upstream] %>;
        <% else %>
        try_files $uri $uri/ $uri.html /index.html =404;
        <% end %>
    }
}

<% end %>

# Redirect naked root_url to www by default
server {
    listen 80;
    listen [::]:80;
	listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name ohsloth.com;
    return 301 https://www.ohsloth.com;
}
