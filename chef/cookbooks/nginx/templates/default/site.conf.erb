<% @upstreams.each do |upstream| %>
upstream <%= upstream.name %> {
    server <%= upstream.address %>;
}
<% end %>

<% @servers.each do |server| %>
# <%= server.name %>
server {
    listen 80;
    listen [::]:80;
    server_name <%= server.fqdn %>;
    return 301 https://$server_name$request_uri;
}
# <%= server.name %>
server {
    # SSL configuration
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    include snippets/ssl-<%= server.root_url %>.conf;
    include snippets/ssl-params.conf;

    server_name <%= server.fqdn %>;
    add_header Strict-Transport-Security "max-age=15768000; includeSubDomains: always;";

    access_log /var/log/nginx/<%= server.name%>/access.log;
    error_log /var/log/nginx/<%= server.name%>/error.log;

    location / {
        <% if server.upstream? %>
        proxy_pass http://<%= server.upstream %>;
        <% else %>
        try_files $uri $uri/ $uri.html /index.html =404;
        <% end %>
    }
}
