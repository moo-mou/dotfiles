#!/usr/local/bin/m_venv/bin/python

import argparse
import logging
import logging.config
import os
import shutil
import subprocess

import ruamel.yaml as yaml

import constant

logger = logging.getLogger(__name__)
logging.config.fileConfig(os.path.join(constant.M_ROOT, './log.conf'))

if os.environ.get('DEBUG', None):
    logger.setLevel(logging.DEBUG)

parser = argparse.ArgumentParser()
parser.add_argument('cmd')
parser.add_argument('--tag', help='for building docker img')
parser.add_argument('--role', help='for reheating')

args = parser.parse_args()

def path(folder):
    return os.path.join(constant.ROOT, folder)

def get_config_yml():
    if os.path.isfile('./config.yml'):
        with open('./config.yml') as f:
            config_yml = yaml.safe_load(f)
            logger.debug('loaded config::', config_yml)
            return config_yml
    return {}

if args.cmd == 'build':
    config_yml = get_config_yml()
    remove_after = ['./gitlab_rsa', './.dockerignore']

    if config_yml.get('resolve'):
        for src, dst in config_yml.get('resolve').items():
            shutil.copy2(src, dst)
            remove_after.append(dst)

    # Copy gitlab cert
    shutil.copy2(os.path.join(constant.SSH_DIR, 'key', 'gitlab_rsa'), './gitlab_rsa')
    # Copy over dockerignore
    shutil.copy2(os.path.join(constant.M_ROOT, '.dockerignore'), './.dockerignore')

    tag = args.tag
    p = subprocess.Popen('docker build . -t %s' % tag, shell=True)
    p.communicate()

    subprocess.check_output('docker save %s | gzip -c > ~/dev/chub/%s.gz' % (tag, tag), shell=True)
    [os.remove(f) for f in remove_after]

    cmd = 'cd %s && git add . && git ci -m updated %s.gz && git push origin master' % (path('chub'), tag)
    p = subprocess.Popen(cmd, shell=True)
    p.communicate()

elif args.cmd == 'deploy':
    app = args.tag

    # first run deploy_assets
    if app == 'slothapp':
        cmd = 'cd %s && ./deploy_asset.sh' % path('dotfiles/m/ops/%s' % app)
        p = subprocess.Popen(cmd, shell=True)
        p.communicate()

    p = subprocess.Popen('cd %s && ./deploy.sh %s' % (path('dotfiles/m/ops'), app), shell=True)
    p.communicate()

elif args.cmd == 'ginit':
    gitignore = args.tag
    gitignore[0] = gitignore[0].upper()

    p = subprocess.Popen('ginit %s' % gitignore, shell=True)
    p.communicate()

elif args.cmd == 'reheat':
    role = args.role

    # cp chef folder to ~/.chef
    chef_run_dir = os.path.expanduser('~/.chef')

    if not os.path.exists(chef_run_dir):
        os.mkdir(chef_run_dir)

    # copy over chef
    print(path('dotfiles/chef'), chef_run_dir)

    p = subprocess.Popen('cp -r %s/* %s' % (path('dotfiles/chef'), chef_run_dir), shell=True)
    p.communicate()

    # run bash install.sh' "$role"
    p = subprocess.Popen('cd %s && sudo bash install.sh %s' % (chef_run_dir, role), shell=True)
    p.communicate()

elif args.cmd == 'mmv':
    # TODO: implement an easy way to mass rename files
    pass

elif args.cmd == 'dload':
    app = args.tag
    p = subprocess.Popen('docker load < %s.gz' % (app, app), shell=True)
    p.communicate()

elif args.cmd == 'compile_template':
    import jinja2

    config = get_config_yml()
    compile_config = config['compile']

    loader = jinja2.FileSystemLoader('./%s' % compile_config['src_dir'], followlinks=True)
    env = jinja2.Environment(loader=loader)

    for temp_name in env.list_templates(
            filter_func=lambda x: not x.startswith('_') and x.endswith(compile_config['ext'])
    ):
        print('Compiling %s...' % temp_name)
        temp = env.get_template(temp_name)

        out_dir = compile_config['out_dir']

        with open('./%s/%s' % (out_dir, temp_name), 'w') as f:
            context = config.get('context', {})
            context['filename'] = os.path.splitext(os.path.basename(temp_name))[0]
            f.write(temp.render(**context).encode('utf-8'))
