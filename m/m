#!/usr/local/bin/m_venv3/bin/python
import json
import logging
import os

import fire

from m_audio import Audio
from m_chef import Chef
from m_deploy import Deploy
from m_docker import Docker
from m_keras import Keras
from m_pipe import Pipe
from m_watcher import Watcher
from m_www import Www
from m_shell import Shell
from m_voixdb import Voixdb

from constant import M_ROOT

with open(os.path.join(M_ROOT, "./log.conf")) as conf:
    logging.config.dictConfig(json.load(conf))
    logger = logging.getLogger()


class M2:
    def __init__(self):
        self.audio = Audio
        self.chef = Chef
        self.deploy = Deploy
        self.docker = Docker
        self.keras = Keras
        self.pipe = Pipe
        self.shell = Shell
        self.voixdb = Voixdb
        self.watcher = Watcher
        self.www = Www

    def update(self):
        """
        Updates the m tool
        """
        import fs_util
        import git_util

        logger.info("updating m tool by rebasing...")
        with fs_util.Cwd(M_ROOT):
            git_util.stash()
            git_util.rebase()
            git_util.stash_pop()


if __name__ == "__main__":
    fire.Fire(M2())
